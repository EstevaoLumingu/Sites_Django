{% extends "main/base.html" %}
{% block title %}Submiss√µes de Matr√≠cula{% endblock %}

{% block content %}
<div class="container my-5">
  <h2 class="text-primary mb-4">
    <i class="fas fa-user-check"></i> Submiss√µes de Matr√≠cula
  </h2>

  <!-- Filtros -->
  <form method="get" class="row g-3 mb-3">
    <div class="col-md-4">
      <select name="curso" class="form-select" onchange="this.form.submit()">
        <option value="">üîç Filtrar por Curso</option>
        {% for curso in cursos %}
          <option value="{{ curso.id }}" {% if curso.id|stringformat:'s' == curso_selecionado %}selected{% endif %}>{{ curso.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <select name="status" class="form-select" onchange="this.form.submit()">
        <option value="">üìÑ Todos os Status</option>
        <option value="pendente" {% if status_selecionado == 'pendente' %}selected{% endif %}>Pendentes</option>
        <option value="aprovado" {% if status_selecionado == 'aprovado' %}selected{% endif %}>Aprovados</option>
        <option value="rejeitado" {% if status_selecionado == 'rejeitado' %}selected{% endif %}>Rejeitados</option>
      </select>
    </div>
    <div class="col-md-4 text-end">
      <span class="badge bg-secondary">Total: {{ total_pedidos }}</span>
    </div>
  </form>

  {% if pedidos %}
  <div class="table-responsive shadow-sm">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Aluno</th>
          <th>Curso</th>
          <th>N√≠vel</th>
          <th>Data</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for p in pedidos %}
        <tr class="{% if p.avaliado and not p.aprovado %}table-danger{% elif p.avaliado and p.aprovado %}table-success{% endif %}">
          <td>{{ p.aluno.get_full_name|default:p.aluno.username }}</td>
          <td>{{ p.curso.nome }}</td>
          <td>{{ p.resultado_teste.nivel_atribuido|capfirst }}</td>
          <td>{{ p.data_solicitacao|date:"d/m/Y H:i" }}</td>
          <td>
            {% if not p.avaliado %}
              <span class="badge bg-warning text-dark">Pendente</span>
            {% elif p.aprovado %}
              <span class="badge bg-success">Aprovado</span>
            {% else %}
              <span class="badge bg-danger">Rejeitado</span>
            {% endif %}
          </td>
          <td class="d-flex gap-2">
            <a href="{% url 'ver_resultado_detalhado' p.resultado_teste.id %}" class="btn btn-sm btn-info" title="Ver Teste Detalhado">
                <i class="fas fa-eye"></i>
              </a>

            <a href="{% url 'avaliar_pedido' p.id %}" class="btn btn-sm btn-primary" title="Avaliar">
              <i class="fas fa-edit"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagina√ß√£o -->
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if pedidos.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ pedidos.previous_page_number }}&curso={{ curso_selecionado }}&status={{ status_selecionado }}">Anterior</a>
        </li>
      {% endif %}

      {% for num in pedidos.paginator.page_range %}
        <li class="page-item {% if pedidos.number == num %}active{% endif %}">
          <a class="page-link" href="?page={{ num }}&curso={{ curso_selecionado }}&status={{ status_selecionado }}">{{ num }}</a>
        </li>
      {% endfor %}

      {% if pedidos.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ pedidos.next_page_number }}&curso={{ curso_selecionado }}&status={{ status_selecionado }}">Pr√≥xima</a>
        </li>
      {% endif %}
    </ul>
  </nav>

  {% else %}
    <div class="alert alert-info text-center shadow-sm">
      <i class="fas fa-info-circle"></i> Nenhum pedido nesta categoria.
    </div>
  {% endif %}
</div>
{% endblock %}
